<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Configuration ---
  const PROMPT_LINKS = [
    "https://aiskillshouse.com/student/qr-mediator.html?uid=2307&promptId=18&v=2",
    "https://aiskillshouse.com/student/qr-mediator.html?uid=2307&promptId=19&v=2",
    "https://aiskillshouse.com/student/qr-mediator.html?uid=2307&promptId=20&v=2",
    "https://aiskillshouse.com/student/qr-mediator.html?uid=2307&promptId=21&v=2",
    "https://aiskillshouse.com/student/qr-mediator.html?uid=2307&promptId=22&v=2"
  ];
  const DELAY_AFTER_LOAD = 4000; // milliseconds to wait per prompt

  // --- UI Elements ---
  const launchBtn = document.getElementById('launchBtn');
  const statusMessage = document.getElementById('status-message');
  const fallbackLinksContainer = document.getElementById('fallback-links');

  // --- Helper: Popup permission check ---
  function checkPopupPermissions() {
    const testWindow = window.open('about:blank', '_blank', 'width=1,height=1,left=9999,top=9999');
    if (!testWindow || testWindow.closed || typeof testWindow.closed === 'undefined') {
      return false;
    }
    testWindow.close();
    return true;
  }

  // --- UI Updates for Permissions ---
  function updateUiForPermissions(allowed) {
    statusMessage.style.display = 'none';
    statusMessage.innerHTML = '';
    fallbackLinksContainer.innerHTML = '';
    if (allowed) {
      launchBtn.disabled = false;
    } else {
      launchBtn.disabled = true;
      statusMessage.className = 'warning';
      statusMessage.innerHTML = `
        <i class="fa-solid fa-triangle-exclamation"></i>
        <strong>Pop-ups Blocked!</strong><br>
        Please allow pop-ups and try again.
        <button class="recheck-btn">Re-check Permissions</button>
      `;
      statusMessage.style.display = 'block';
    }
  }

  // --- Sequential Navigation Logic ---
  async function openPromptsSequentially() {
    if (!checkPopupPermissions()) {
      updateUiForPermissions(false);
      return;
    }

    launchBtn.classList.add('loading');
    launchBtn.disabled = true;
    statusMessage.style.display = 'block';
    statusMessage.className = '';
    statusMessage.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Launching prompts...`;

    try {
      const tab = window.open(PROMPT_LINKS[0], '_blank');
      if (!tab) {
        statusMessage.className = 'warning';
        statusMessage.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Pop-up blocked.`;
        return;
      }

      await waitForPageLoad(tab);

      for (let i = 1; i < PROMPT_LINKS.length; i++) {
        statusMessage.innerHTML = `<i class="fa-solid fa-hourglass-half"></i> Loading prompt ${i + 1} of ${PROMPT_LINKS.length}...`;
        await navigateAndWait(tab, PROMPT_LINKS[i]);
      }

      statusMessage.className = 'success';
      statusMessage.innerHTML = `<i class="fa-solid fa-check-circle"></i> Successfully launched all ${PROMPT_LINKS.length} prompts!`;
      setTimeout(() => {
        tab.close();
        launchBtn.classList.remove('loading');
        launchBtn.disabled = false;
        statusMessage.innerHTML += `<br><small>Tab closed automatically.</small>`;
      }, 2000);
    } catch (err) {
      console.error(err);
      statusMessage.className = 'warning';
      statusMessage.innerHTML = `<i class="fa-solid fa-bug"></i> Error launching prompts.`;
    }
  }

  // --- Helpers: Wait until a page loads ---
  function waitForPageLoad(tab) {
    return new Promise(resolve => {
      const check = setInterval(() => {
        try {
          if (tab.document.readyState === 'complete') {
            clearInterval(check);
            setTimeout(resolve, DELAY_AFTER_LOAD);
          }
        } catch {
          // ignore cross-origin load errors
        }
      }, 500);
    });
  }

  function navigateAndWait(tab, url) {
    return new Promise(resolve => {
      const start = Date.now();
      const check = setInterval(() => {
        try {
          if (tab.document.readyState === 'complete' && Date.now() - start > 1000) {
            clearInterval(check);
            setTimeout(resolve, DELAY_AFTER_LOAD);
          }
        } catch {}
      }, 500);
      tab.location.href = url;
      setTimeout(resolve, DELAY_AFTER_LOAD + 2000); // fallback timeout
    });
  }

  // --- Event Bindings ---
  launchBtn.addEventListener('click', openPromptsSequentially);
  statusMessage.addEventListener('click', e => {
    if (e.target.closest('.recheck-btn')) {
      updateUiForPermissions(checkPopupPermissions());
    }
  });

  // Initial check
  updateUiForPermissions(checkPopupPermissions());
});
</script>
